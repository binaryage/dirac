{"version":3,"file":"coverage.js","sourceRoot":"","sources":["../../src/istanbul/coverage.ts"],"names":[],"mappings":"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","sourcesContent":["import { Logger } from \"log4js\";\n\nimport * as convertSourceMap from \"convert-source-map\";\nimport * as istanbul from \"istanbul-lib-instrument\";\nimport * as path from \"path\";\n\nimport { EmitOutput } from \"../compiler/emit-output\";\nimport { Configuration } from \"../shared/configuration\";\nimport { File } from \"../shared/file\";\nimport { CoverageCallback } from \"./coverage-callback\";\n\nexport class Coverage {\n\n    private instrumenter: istanbul.Instrumenter;\n    private log: Logger;\n\n    constructor(private config: Configuration) { }\n\n    public initialize(logger: any): void {\n\n        this.log = logger.create(\"coverage.karma-typescript\");\n        this.log.debug(\"Initializing\");\n\n        this.config.whenReady(() => {\n            this.log.debug(\"Configuring coverage preprocessor\");\n            this.instrumenter = istanbul.createInstrumenter(this.config.coverageOptions.instrumenterOptions);\n        });\n    }\n\n    public instrument(file: File, bundled: string, emitOutput: EmitOutput, callback: CoverageCallback): void {\n\n        if (this.config.hasPreprocessor(\"commonjs\")) {\n            this.log.debug(\"karma-commonjs already configured\");\n            callback(bundled);\n            return;\n        }\n\n        if (this.config.hasPreprocessor(\"coverage\")) {\n            this.log.debug(\"karma-coverage already configured\");\n            callback(bundled);\n            return;\n        }\n\n        if (!this.config.coverageOptions.instrumentation ||\n            this.isExcluded(this.config.coverageOptions.exclude, file.relativePath) ||\n            this.hasNoOutput(emitOutput)) {\n\n            this.log.debug(\"Excluding file %s from instrumentation\", file.originalPath);\n            callback(bundled);\n            return;\n        }\n\n        this.log.debug(\"Processing \\\"%s\\\".\", file.originalPath);\n\n        let sourceMap = convertSourceMap.fromSource(bundled);\n\n        if (!sourceMap) {\n            sourceMap = convertSourceMap.fromMapFileSource(bundled, path.dirname(file.originalPath));\n        }\n\n        this.instrumenter.instrument(bundled, file.originalPath, (error, instrumentedSource) => {\n            if (error) {\n                this.log.error(\"%s\\nin %s\", error.message, file.originalPath);\n                callback(error.message);\n            }\n            else {\n                callback(instrumentedSource);\n            }\n        }, sourceMap ? sourceMap.sourcemap : undefined);\n    }\n\n    private hasNoOutput(emitOutput: EmitOutput): boolean {\n        return emitOutput.outputText.startsWith(\"//# sourceMappingURL=\");\n    }\n\n    private isExcluded(regex: RegExp | RegExp[], filePath: string): boolean {\n        if (Array.isArray(regex)) {\n            for (const r of regex) {\n                if (r.test(filePath)) {\n                    return true;\n                }\n            }\n            return false;\n        }\n        return regex.test(filePath);\n    }\n}\n"]}